#!/bin/bash

# üö® –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï BACKEND CRASH
echo "üö® –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï BACKEND CRASH"
echo "============================"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–∞–ø–∫—É
cd /opt/sofiya

# 1. –ü–†–û–í–ï–†–Ø–ï–ú –°–¢–ê–¢–£–° PM2
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å PM2..."
pm2 status

# 2. –ü–†–û–í–ï–†–Ø–ï–ú –õ–û–ì–ò BACKEND
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ backend..."
pm2 logs backend --lines 20

# 3. –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –í–°–ï –ü–†–û–¶–ï–°–°–´
echo "3Ô∏è‚É£ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 stop all

# 4. –ü–ï–†–ï–•–û–î–ò–ú –í BACKEND –ü–ê–ü–ö–£
echo "4Ô∏è‚É£ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ backend –ø–∞–ø–∫—É..."
cd backend

# 5. –ê–ö–¢–ò–í–ò–†–£–ï–ú –í–ò–†–¢–£–ê–õ–¨–ù–û–ï –û–ö–†–£–ñ–ï–ù–ò–ï
echo "5Ô∏è‚É£ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
source venv/bin/activate

# 6. –ü–†–û–í–ï–†–Ø–ï–ú –ó–ê–í–ò–°–ò–ú–û–°–¢–ò
echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip list | grep -E "(fastapi|uvicorn|python-telegram-bot)"

# 7. –¢–ï–°–¢–ò–†–£–ï–ú BACKEND –ù–ê–ü–†–Ø–ú–£–Æ
echo "7Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä—É–µ–º backend –Ω–∞–ø—Ä—è–º—É—é..."
python -c "
import sys
sys.path.append('.')
try:
    from app.main import app
    print('‚úÖ Backend –∏–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω')
except Exception as e:
    print(f'‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}')
    sys.exit(1)
"

# 8. –ó–ê–ü–£–°–ö–ê–ï–ú BACKEND –í–†–£–ß–ù–£–Æ
echo "8Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º backend –≤—Ä—É—á–Ω—É—é..."
cd /opt/sofiya/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload &
BACKEND_PID=$!

# 9. –ñ–î–ï–ú –ó–ê–ü–£–°–ö–ê
echo "9Ô∏è‚É£ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ backend..."
sleep 5

# 10. –ü–†–û–í–ï–†–Ø–ï–ú –ß–¢–û BACKEND –†–ê–ë–û–¢–ê–ï–¢
echo "üîü –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ backend —Ä–∞–±–æ—Ç–∞–µ—Ç..."
curl -s http://localhost:8000/health || echo "‚ùå Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

# 11. –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –†–£–ß–ù–û–ô –ó–ê–ü–£–°–ö
echo "1Ô∏è‚É£1Ô∏è‚É£ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫..."
kill $BACKEND_PID 2>/dev/null || true

# 12. –ó–ê–ü–£–°–ö–ê–ï–ú –ß–ï–†–ï–ó PM2
echo "1Ô∏è‚É£2Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ PM2..."
cd /opt/sofiya
pm2 start ecosystem.config.js

# 13. –ü–†–û–í–ï–†–Ø–ï–ú –°–¢–ê–¢–£–°
echo "1Ô∏è‚É£3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
pm2 status

# 14. –ü–†–û–í–ï–†–Ø–ï–ú –õ–û–ì–ò
echo "1Ô∏è‚É£4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏..."
pm2 logs backend --lines 10

# 15. –¢–ï–°–¢–ò–†–£–ï–ú API
echo "1Ô∏è‚É£5Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä—É–µ–º API..."
sleep 3
curl -s https://mcp-kv.ru/mcp/tools | head -c 100
echo ""

echo ""
echo "üéØ BACKEND CRASH –ò–°–ü–†–ê–í–õ–ï–ù!"
echo "‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
echo "‚úÖ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç"
echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω"
echo ""
echo "üîç –¢–µ–ø–µ—Ä—å –∑–∞–π–¥–∏ –Ω–∞ —Å–∞–π—Ç –∏ –ø—Ä–æ–≤–µ—Ä—å!"
