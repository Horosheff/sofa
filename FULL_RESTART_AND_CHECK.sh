#!/bin/bash

# üîÑ –ü–û–õ–ù–´–ô –ü–ï–†–ï–ó–ê–ü–£–°–ö –ò –ü–†–û–í–ï–†–ö–ê
echo "üîÑ –ü–û–õ–ù–´–ô –ü–ï–†–ï–ó–ê–ü–£–°–ö –ò –ü–†–û–í–ï–†–ö–ê"
echo "==============================="

cd /opt/sofiya

# 1. –ü–†–û–í–ï–†–Ø–ï–ú –ß–¢–û –í–û–ó–í–†–ê–©–ê–ï–¢ /mcp/tools –î–û –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç /mcp/tools –î–û –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞..."
curl -s https://mcp-kv.ru/mcp/tools > /tmp/mcp_tools_before.json
echo "–ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤:"
head -c 100 /tmp/mcp_tools_before.json
echo ""
echo ""

# 2. –ü–†–û–í–ï–†–Ø–ï–ú –ö–û–î ENDPOINT –í MAIN.PY
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ endpoint –≤ main.py..."
grep -A 25 '@app.get("/mcp/tools")' backend/app/main.py
echo ""

# 3. –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –í–°–Å
echo "3Ô∏è‚É£ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å—ë..."
pm2 stop all

# 4. –û–ß–ò–©–ê–ï–ú –ö–≠–®–ò
echo "4Ô∏è‚É£ –û—á–∏—â–∞–µ–º –∫—ç—à–∏..."
cd frontend
rm -rf .next/cache/
cd ..

# 5. –ó–ê–ü–£–°–ö–ê–ï–ú –í–°–Å –ó–ê–ù–û–í–û
echo "5Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å—ë –∑–∞–Ω–æ–≤–æ..."
pm2 start all

# 6. –ñ–î–ï–ú –ó–ê–ü–£–°–ö–ê
echo "6Ô∏è‚É£ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞..."
sleep 5

# 7. –ü–†–û–í–ï–†–Ø–ï–ú –°–¢–ê–¢–£–°
echo "7Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
pm2 status

# 8. –ü–†–û–í–ï–†–Ø–ï–ú –ß–¢–û –í–û–ó–í–†–ê–©–ê–ï–¢ /mcp/tools –ü–û–°–õ–ï –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê
echo "8Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç /mcp/tools –ü–û–°–õ–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞..."
curl -s https://mcp-kv.ru/mcp/tools > /tmp/mcp_tools_after.json
echo "–ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤:"
head -c 100 /tmp/mcp_tools_after.json
echo ""
echo ""

# 9. –ü–†–û–í–ï–†–Ø–ï–ú –õ–û–ì–ò BACKEND
echo "9Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ backend..."
pm2 logs backend --lines 10 --nostream

# 10. –ü–†–û–í–ï–†–Ø–ï–ú –õ–û–ì–ò FRONTEND
echo "üîü –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ frontend..."
pm2 logs frontend --lines 10 --nostream

echo ""
echo "üéØ –ü–û–õ–ù–´–ô –ü–ï–†–ï–ó–ê–ü–£–°–ö –ó–ê–í–ï–†–®–ï–ù!"
echo ""
echo "–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—å —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ!"
echo ""
echo "–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ—Å—Ç–∞–ª–∞—Å—å, –ø—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª /tmp/mcp_tools_after.json"
echo "–û–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ–±—ä–µ–∫—Ç –≤–∏–¥–∞:"
echo '{"WordPress": [...], "Wordstat": [...], "Telegram": [...]}'
echo ""
echo "–ê –ù–ï –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–∞:"
echo '[{"name": "wordpress_get_posts", ...}, ...]'
